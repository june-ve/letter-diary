<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>LetterDiary - êµí™˜ì¼ê¸°</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #e6ddcf;
      color: #3b2f2f;
    }

    .app-container {
      display: flex;
      min-height: 100vh;
      padding: 32px;
    }

    /* í¼ì³ì§„ ì¼ê¸°ì¥ íŒ¨ë„ */
    .diary-panel {
      flex: 1;
      margin: auto;
      max-width: 980px;
      background: radial-gradient(circle at top, #f9f5ec 0, #f0e6d5 60%, #e1d3c0 100%);
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      padding: 20px 28px;
      display: flex;
      flex-direction: column;
    }

    .diary-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 12px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
      padding-bottom: 8px;
    }

    .diary-title {
      font-size: 23px;
      font-weight: 700;
    }

    .diary-partner-label {
      font-size: 13px;
      opacity: 0.75;
    }

    .diary-body {
      flex: 1;
      display: flex;
      gap: 18px;
      margin-top: 10px;
    }

    .diary-left, .diary-right {
      flex: 1;
      background: #fdf7ea;
      border-radius: 12px;
      padding: 16px 18px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.04);
      position: relative;
    }

    /* ìŠ¤í”„ë§(ë°”ì¸ë”©) ëŠë‚Œ */
    .diary-left::before,
    .diary-right::before {
      content: "";
      position: absolute;
      top: 0;
      bottom: 0;
      width: 6px;
      background: repeating-linear-gradient(
              180deg,
              rgba(196, 167, 132, 0.8),
              rgba(196, 167, 132, 0.8) 2px,
              rgba(228, 205, 176, 0.8) 2px,
              rgba(228, 205, 176, 0.8) 4px
      );
      opacity: 0.3;
    }

    .diary-left::before {
      left: -4px;
      border-radius: 8px 0 0 8px;
    }

    .diary-right::before {
      right: -4px;
      border-radius: 0 8px 8px 0;
    }

    .diary-section-title {
      font-size: 14px;
      opacity: 0.7;
      margin-bottom: 6px;
    }

    .message-meta {
      font-size: 12px;
      opacity: 0.85;
      margin-bottom: 8px;
    }

    .message-content {
      white-space: pre-wrap;
      line-height: 1.6;
      font-size: 14px;
    }

    .message-empty {
      opacity: 0.5;
      font-size: 13px;
    }

    .navigation-row {
      display: flex;
      justify-content: space-between;
      margin-top: 18px;
    }

    .nav-btn {
      padding: 8px 14px;
      background: #d8c8b4;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
    }

    .nav-btn:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .diary-right textarea {
      width: 100%;
      height: 140px;
      resize: none;
      border: none;
      background: transparent;
      outline: none;
      font-family: inherit;
      font-size: 14px;
      line-height: 1.6;
    }

    .send-row {
      display: flex;
      justify-content: flex-end;
      margin-top: 10px;
      gap: 8px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
    }

    .btn-primary {
      background: #b56d57;
      color: white;
    }

    .btn-primary:hover {
      background: #9c5843;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid rgba(0,0,0,0.15);
    }

    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px 18px;
      border-radius: 999px;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }
  </style>
</head>

<body>
<th:block th:replace="~{fragments/header :: headerFragment}"></th:block>

<div class="app-container">

  <section class="diary-panel">

    <header class="diary-header">
      <div class="diary-title" id="diaryTitle">êµí™˜ì¼ê¸°</div>
      <div class="diary-partner-label" id="diaryPartnerLabel"></div>
    </header>

    <div class="diary-body">

      <!-- ì™¼ìª½ í˜ì´ì§€: ë©”ì‹œì§€ í•œ ì¥ -->
      <div class="diary-left">
        <div id="messageContainer">
          <div class="message-empty">(ì•„ì§ ì‘ì„±ëœ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.)</div>
        </div>

        <div class="navigation-row">
          <button class="nav-btn" id="prevBtn">â—€ ì´ì „</button>
          <button class="nav-btn" id="nextBtn">ë‹¤ìŒ â–¶</button>
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½ í˜ì´ì§€: ìƒˆ ì¼ê¸° ì‘ì„± -->
      <div class="diary-right">
        <div class="diary-section-title">ìƒˆ ì¼ê¸° ì“°ê¸°</div>
        <textarea id="newMessageContent" placeholder="ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ í¸ì§€ì²˜ëŸ¼ ì ì–´ë³´ì„¸ìš”..."></textarea>

        <div class="send-row">
          <button class="btn btn-outline" id="downloadBtn">txt ë‹¤ìš´ë¡œë“œ</button>
          <button class="btn btn-primary" id="sendBtn">ë³´ë‚´ê¸°</button>
        </div>
      </div>

    </div>
  </section>
</div>

<div class="toast" id="toast">ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ’Œ</div>

<script>
  const token = localStorage.getItem("token");
  if (!token) {
    window.location.href = "/login";
  }

  const threadId = window.location.pathname.split("/").pop();
  let currentPage = 0;
  let totalPages = 1;

  async function loadMessagePage(page = 0) {
    const res = await fetch(`/api/threads/${threadId}/messages?page=${page}`, {
      headers: { "Authorization": "Bearer " + token }
    });

    if (!res.ok) {
      messageContainer.innerHTML =
              `<div class="message-empty">ì•„ì§ ì‘ì„±ëœ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      return;
    }

    const data = await res.json();
    currentPage = data.currentPage;
    totalPages = data.totalPages;

    diaryTitle.textContent = data.threadTitle ?? "êµí™˜ì¼ê¸°";

    messageContainer.innerHTML = `
      <div class="message-meta">
          ğŸ“† ${data.createdAt.replace('T', ' ')}<br>
          ğŸ‘¤ ${data.senderNickname}
      </div>
      <div class="message-content">${data.content}</div>
    `;

    prevBtn.disabled = currentPage >= totalPages - 1;
    nextBtn.disabled = currentPage <= 0;
  }

  prevBtn.onclick = () => loadMessagePage(currentPage + 1);
  nextBtn.onclick = () => loadMessagePage(currentPage - 1);

  document.getElementById("downloadBtn").onclick = async () => {
    const res = await fetch(`/api/threads/${threadId}/download`, {
      headers: { "Authorization": "Bearer " + token }
    });

    if (!res.ok) {
      showToast("ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      return;
    }

    const blob = await res.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");

    // í—¤ë”ì—ì„œ íŒŒì¼ëª… ì¶”ì¶œ
    const disposition = res.headers.get("Content-Disposition");
    let filename = "diary.txt";

    if (disposition) {
      const utf8FilenameRegex = /filename\*=UTF-8''([^;]+)/i;
      const asciiFilenameRegex = /filename=(["']?)(.*?[^\\])\1(?:; ?|$)/i;

      if (utf8FilenameRegex.test(disposition)) {
        const match = disposition.match(utf8FilenameRegex);
        filename = decodeURIComponent(match[1]);
      } else if (asciiFilenameRegex.test(disposition)) {
        const match = disposition.match(asciiFilenameRegex);
        filename = match[2].replace(/"/g, '');
      }
    }

    a.href = url;
    a.download = filename;
    document.body.appendChild(a);

    a.click();
    showToast("ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ âœ¨");
    a.remove();
    window.URL.revokeObjectURL(url);
  };

  document.getElementById("sendBtn").onclick = async () => {
    const content = document.getElementById("newMessageContent").value.trim();
    if (!content) {
      showToast("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš” âœï¸");
      return;
    }

    const res = await fetch(`/api/threads/${threadId}/messages`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({ content })
    });

    if (res.ok) {
      document.getElementById("newMessageContent").value = "";
      showToast("ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ’Œ");
      loadMessagePage(0);
    }
  };

  loadMessagePage(0);
</script>

</body>
</html>
